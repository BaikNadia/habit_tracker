name: habit_tracker

on: [push, pull_request]

env:
  GITHUB_ACTIONS: true

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install flake8
        run: |
          python -m pip install --upgrade pip
          pip install flake8

      - name: Run flake8
        run: flake8 .

  test:
    needs: lint
    runs-on: ubuntu-latest
    env:
      GITHUB_ACTIONS: true

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install coverage

      - name: Set up environment variables for tests
        run: |
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> $GITHUB_ENV
          echo "DEBUG=True" >> $GITHUB_ENV
          echo "ALLOWED_HOSTS=localhost,127.0.0.1" >> $GITHUB_ENV
          echo "TELEGRAM_BOT_TOKEN=dummy_token_for_tests" >> $GITHUB_ENV
          echo "CELERY_BROKER_URL=redis://localhost:6379/0" >> $GITHUB_ENV
          echo "CELERY_RESULT_BACKEND=redis://localhost:6379/0" >> $GITHUB_ENV

      - name: Run migrations and tests
        run: |
          python manage.py makemigrations --no-input
          python manage.py migrate --run-syncdb
          coverage run --source='.' manage.py test habits users telegram_bot -v 2

      - name: Generate coverage report
        run: |
          coverage report
          coverage xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: Clean up test database
        run: |
          rm -f test_db.sqlite3

  build:
    needs: test
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/habit-tracker:${{ github.sha }} .

      - name: Test Docker image
        run: |
          # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –æ–±—Ä–∞–∑ —Å–æ–∑–¥–∞–Ω –∏ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
          echo "=== Testing Docker image ==="
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ —Å—Ä–∞–∑—É —Å–º–æ—Ç—Ä–∏–º –ª–æ–≥–∏
          echo "Starting container..."
          docker run --name test-container -p 8000:8000 \
            -e SECRET_KEY=test-key-for-docker \
            -e DEBUG=True \
            -e ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0 \
            -e TELEGRAM_BOT_TOKEN=test-token \
            -e CELERY_BROKER_URL=redis://redis:6379/0 \
            -e CELERY_RESULT_BACKEND=redis://redis:6379/0 \
            -e DB_ENGINE=django.db.backends.sqlite3 \
            -e DB_NAME=db.sqlite3 \
            ${{ secrets.DOCKERHUB_USERNAME }}/habit-tracker:${{ github.sha }} &

          # –î–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫
          sleep 10
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          echo "=== Container status ==="
          docker ps -a | grep test-container
          
          # –°–º–æ—Ç—Ä–∏–º –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
          echo "=== Container logs ==="
          docker logs test-container || echo "Cannot get logs - container may have exited"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–≤–µ—á–∞–µ—Ç –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          echo "=== Testing application response ==="
          timeout 10 bash -c 'until curl -f http://localhost:8000/ 2>/dev/null; do sleep 1; done' || echo "Application not responding"
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ –æ–Ω –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
          docker stop test-container 2>/dev/null || true
          docker rm test-container 2>/dev/null || true

      - name: Simple image test
        run: |
          # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–Ω –Ω–µ –ø–∞–¥–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
          echo "=== Simple container test ==="
          container_id=$(docker run -d --name simple-test \
            -e SECRET_KEY=test-key \
            -e DEBUG=True \
            -e ALLOWED_HOSTS=* \
            ${{ secrets.DOCKERHUB_USERNAME }}/habit-tracker:${{ github.sha }})
          
          sleep 5
          
          if docker ps | grep -q simple-test; then
            echo "‚úÖ Container is running"
            docker logs simple-test --tail 10
            docker stop simple-test
            docker rm simple-test
          else
            echo "‚ùå Container stopped immediately"
            docker logs simple-test --tail 20
            exit 1
          fi

      - name: Push Docker image to Docker Hub
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/habit-tracker:${{ github.sha }}
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/habit-tracker:${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/habit-tracker:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/habit-tracker:latest

  deploy:
    needs: build
    if: github.event_name != 'pull_request' && github.ref == 'refs/heads/feature/task-4'
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
          set -e
          echo "Starting deployment from feature/task-4 branch..."
          
          # Pull the latest image
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/habit-tracker:${{ github.sha }}
          
          # Stop and remove old container if exists
          docker stop habit_tracker || true
          docker rm habit_tracker || true
          
          # Create network if not exists
          docker network create habit_network || true
          
          # Run new container with environment variables
          docker run -d \
            --name habit_tracker \
            --network habit_network \
            -p 80:8000 \
            -e SECRET_KEY='${{ secrets.SECRET_KEY }}' \
            -e DEBUG=False \
            -e ALLOWED_HOSTS='${{ secrets.SERVER_IP }},localhost,127.0.0.1' \
            -e DB_NAME='${{ secrets.DB_NAME }}' \
            -e DB_USER='${{ secrets.DB_USER }}' \
            -e DB_PASSWORD='${{ secrets.DB_PASSWORD }}' \
            -e DB_HOST='${{ secrets.DB_HOST }}' \
            -e DB_PORT='5432' \
            -e TELEGRAM_BOT_TOKEN='${{ secrets.TELEGRAM_BOT_TOKEN }}' \
            -e CELERY_BROKER_URL='redis://${{ secrets.REDIS_HOST }}:6379/0' \
            -e CELERY_RESULT_BACKEND='redis://${{ secrets.REDIS_HOST }}:6379/0' \
            ${{ secrets.DOCKERHUB_USERNAME }}/habit-tracker:${{ github.sha }}
          
          # Clean up old images
          docker image prune -f
          
          echo "Deployment from feature/task-4 completed successfully!"
          EOF

      - name: Verify deployment
        run: |
          sleep 30
          curl -f http://${{ secrets.SERVER_IP }}/api/habits/public/ || curl -f http://${{ secrets.SERVER_IP }}/swagger/ || echo "Deployment verification in progress..."

  notify:
    needs: deploy
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Notify deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "üöÄ Deployment from feature/task-4 completed successfully!"
            echo "Application is available at: http://${{ secrets.SERVER_IP }}/"
          else
            echo "‚ùå Deployment from feature/task-4 failed"
          fi