  deploy:
    needs: build
    if: github.event_name != 'pull_request' && github.ref == 'refs/heads/feature/task-4'
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          ssh -o BatchMode=yes -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} "echo 'SSH connection successful'"

      - name: Deploy to server
        run: |
          ssh -o BatchMode=yes -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
          set -e
          echo "Starting deployment from feature/task-4 branch..."
          
          # Log in to Docker Hub on server
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          
          # Pull the latest image
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/habit-tracker:${{ github.sha }}
          
          # Stop and remove old container if exists
          docker stop habit_tracker || true
          docker rm habit_tracker || true
          
          # Create network if not exists
          docker network create habit_network || true
          
          # Run new container with environment variables
          docker run -d \
            --name habit_tracker \
            --network habit_network \
            -p 80:8000 \
            -e SECRET_KEY='${{ secrets.SECRET_KEY }}' \
            -e DEBUG=False \
            -e ALLOWED_HOSTS='${{ secrets.SERVER_IP }},localhost,127.0.0.1' \
            -e DB_NAME='${{ secrets.DB_NAME }}' \
            -e DB_USER='${{ secrets.DB_USER }}' \
            -e DB_PASSWORD='${{ secrets.DB_PASSWORD }}' \
            -e DB_HOST='${{ secrets.DB_HOST }}' \
            -e DB_PORT='5432' \
            -e TELEGRAM_BOT_TOKEN='${{ secrets.TELEGRAM_BOT_TOKEN }}' \
            -e CELERY_BROKER_URL='redis://${{ secrets.REDIS_HOST }}:6379/0' \
            -e CELERY_RESULT_BACKEND='redis://${{ secrets.REDIS_HOST }}:6379/0' \
            ${{ secrets.DOCKERHUB_USERNAME }}/habit-tracker:${{ github.sha }}
          
          # Clean up old images
          docker image prune -f
          
          echo "Deployment from feature/task-4 completed successfully!"
          EOF

      - name: Wait for deployment
        run: |
          echo "Waiting for application to start..."
          sleep 30

      - name: Verify deployment
        run: |
          echo "=== Verifying deployment ==="
          curl -f http://${{ secrets.SERVER_IP }}/ || \
          curl -f http://${{ secrets.SERVER_IP }}/api/habits/public/ || \
          curl -f http://${{ secrets.SERVER_IP }}/swagger/ || \
          echo "Application might be starting..."

      - name: Check container status
        run: |
          ssh -o BatchMode=yes -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} "docker ps -a | grep habit_tracker && echo '=== Container logs ===' && docker logs habit_tracker --tail 50 || echo 'Container not found'"